{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ContextFlow{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>

<body class="sb-expanded">
    <aside>
        <nav>
            <ul>
                <li>
                    <a href="#" onclick="toggleSidebar(event)">
                        <img src="{% static 'images/sidebar.svg' %}" width="24" height="24" alt="Menu">
                    </a>
                </li>
                <li>
                    <a href="{% url 'new_conversation' %}">
                        <img src="{% static 'images/chat.svg' %}" width="24" height="24" alt="New">
                        <span>New Chat</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'chats' %}">
                        <img src="{% static 'images/search.svg' %}" width="24" height="24" alt="Search">
                        <span>Search</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'files' %}">
                        <img src="{% static 'images/document.svg' %}" width="24" height="24" alt="Docs">
                        <span>Documents</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'chats' %}">
                        <img src="{% static 'images/history.svg' %}" width="24" height="24" alt="History">
                        <span>History</span>
                    </a>
                </li>
                {% if user.is_authenticated and conversations %}
                <li class="chat-history-section">
                    <div class="sidebar-section-header">Recent</div>
                    <div class="chat-history-list">
                        {% for conv in conversations %}
                        <a href="{% url 'load_conversation' conv.id %}"
                           class="chat-history-item {% if conversation.id == conv.id %}active{% endif %}">
                            <span class="chat-title">{{ conv.title|truncatechars:28 }}</span>
                            <button class="chat-delete" data-id="{{ conv.id }}" title="Delete">&times;</button>
                        </a>
                        {% endfor %}
                    </div>
                </li>
                {% endif %}
                <li>
                    <a href="#">
                        <img src="{% static 'images/settings.svg' %}" width="24" height="24" alt="Settings">
                        <span>Settings</span>
                    </a>
                </li>
                
            </ul>
        </nav>
    </aside>

    <nav>
        <div class="logo">ContextFlow</div>
        <div class="nav-links">
            {% if user.is_authenticated %}
                <a href="{% url 'logout' %}">Logout</a>
            {% else %}
                <a href="{% url 'login' %}">Login</a>
                <a href="{% url 'signup' %}">Sign Up For Free</a>
            {% endif %}
        </div>
    </nav>

    <main>
        {% block content %}{% endblock %}
    </main>

    <script>
        function toggleSidebar(e) {
            e.preventDefault();
            document.body.classList.toggle("sb-expanded");
            localStorage.setItem("sidebar-expanded", document.body.classList.contains("sb-expanded"));
        }

        document.addEventListener("DOMContentLoaded", function () {
            if (localStorage.getItem("sidebar-expanded") === "false") {
                document.body.classList.remove("sb-expanded");
            }
        });

        document.addEventListener("click", function(e) {
            const btn = e.target.closest(".chat-delete");
            if (!btn) return;
            e.preventDefault();
            e.stopPropagation();
            const convId = btn.dataset.id;
            fetch(`/documents/conversation/${convId}/delete/`, {
                method: "POST",
                headers: { "X-CSRFToken": "{{ csrf_token }}" }
            }).then(r => r.json()).then(data => {
                if (data.success) location.reload();
            });
        });
    </script>
</body>
</html>